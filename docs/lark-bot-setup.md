# 飞书机器人配置指南

本文档将指导您如何配置飞书机器人，以便接收新闻推送服务的消息。

## 1. 创建飞书自定义机器人

### 步骤 1: 进入飞书群聊
1. 打开需要接收新闻推送的飞书群聊
2. 点击群聊右上角的设置按钮

### 步骤 2: 添加机器人
1. 在群设置中选择「机器人」
2. 点击「添加机器人」
3. 选择「自定义机器人」

### 步骤 3: 配置机器人
1. **机器人名称**: 输入机器人名称，例如「NewsNow 新闻推送」
2. **机器人描述**: 输入描述，例如「定时推送热门新闻摘要」
3. **头像**: 可选择合适的头像

### 步骤 4: 安全设置（推荐）
为了提高安全性，建议启用以下安全设置之一：

#### 方式一：自定义关键词
- 勾选「自定义关键词」
- 输入关键词，例如：`新闻`、`NewsNow`
- 只有包含这些关键词的消息才会被发送

#### 方式二：签名校验（推荐）
- 勾选「签名校验」
- 系统会生成一个密钥，请妥善保存
- 将此密钥配置到 `.env` 文件的 `LARK_BOT_SECRET` 中

#### 方式三：IP白名单
- 勾选「IP白名单」
- 添加服务器的公网IP地址

### 步骤 5: 获取 Webhook URL
1. 完成配置后，点击「完成」
2. 复制生成的 Webhook URL
3. URL 格式类似：`https://open.feishu.cn/open-apis/bot/v2/hook/你的webhook地址`

## 2. 配置项目环境变量

编辑项目根目录下的 `.env` 文件：

```bash
# 飞书机器人配置
LARK_BOT_ENABLED=true
LARK_BOT_WEBHOOK_URL=https://open.feishu.cn/open-apis/bot/v2/hook/你的webhook地址
LARK_BOT_SECRET=你的签名密钥（如果启用了签名校验）
```

### 配置说明

- `LARK_BOT_ENABLED`: 是否启用飞书机器人推送
  - `true`: 启用
  - `false`: 禁用

- `LARK_BOT_WEBHOOK_URL`: 飞书机器人的 Webhook URL（必填）
  - 从飞书群机器人设置中获取
  - 格式：`https://open.feishu.cn/open-apis/bot/v2/hook/你的webhook地址`

- `LARK_BOT_SECRET`: 签名校验密钥（可选，但推荐设置）
  - 如果在创建机器人时启用了签名校验，则必须填写
  - 用于验证消息的合法性，提高安全性

## 3. 测试机器人连接

配置完成后，可以通过以下方式测试机器人是否正常工作：

### 方式一：使用测试命令
```bash
npm start -- --test
```

### 方式二：手动执行一次推送
```bash
npm start -- --once
```

### 方式三：启动定时服务
```bash
npm start
```

## 4. 消息格式说明

系统支持两种消息格式：

### 富文本消息（推荐）
- 支持文本样式（粗体、斜体、下划线）
- 支持链接
- 更好的视觉效果

### 普通文本消息（降级方案）
- 纯文本格式
- 当富文本消息发送失败时自动降级
- 确保消息能够正常发送

## 5. 常见问题

### Q: 机器人创建成功但收不到消息
A: 请检查以下几点：
1. 确认 `LARK_BOT_ENABLED=true`
2. 确认 Webhook URL 正确无误
3. 如果启用了签名校验，确认密钥配置正确
4. 检查服务器网络是否能访问飞书 API

### Q: 提示签名校验失败
A: 
1. 确认 `LARK_BOT_SECRET` 配置正确
2. 确认服务器时间准确（签名包含时间戳）
3. 可以暂时关闭签名校验进行测试

### Q: 消息发送频率限制
A: 飞书机器人有发送频率限制：
- 每个机器人每分钟最多发送 20 条消息
- 建议合理设置推送频率，避免触发限制

### Q: 如何修改消息格式
A: 
- 消息格式在 `src/services/lark-bot.ts` 中定义
- 可以根据需要自定义消息内容和样式
- 支持 Markdown 格式和富文本格式

## 6. 安全建议

1. **启用签名校验**: 防止恶意请求
2. **定期更换密钥**: 提高安全性
3. **限制IP访问**: 如果服务器IP固定，建议使用IP白名单
4. **监控异常**: 关注日志中的错误信息
5. **备份配置**: 妥善保存 Webhook URL 和密钥

## 7. 相关链接

- [飞书开放平台文档](https://open.larkoffice.com/)
- [自定义机器人指南](https://open.larkoffice.com/document/client-docs/bot-v3/add-custom-bot)
- [Webhook 机器人开发指南](https://open.larkoffice.com/document/ukTMukTMukTM/ucTM5YjL3ETO24yNxkjN)